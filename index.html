<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>UTM-—Å–∏—Å—Ç–µ–º–∞ –¥–ª—è –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body { margin: 0; font-family: Arial, sans-serif; background: #0f1a20; color: #a3e4db; }
    #map { height: 100vh; width: 100%; }
    .sidebar {
      position: absolute;
      left: 0;
      top: 0;
      width: 300px;
      height: 100vh;
      background: linear-gradient(135deg, #1e2a32, #0f1a20);
      padding: 15px;
      z-index: 1000;
      overflow-y: auto;
      border-right: 2px solid #00c4cc;
      box-shadow: 2px 0 10px rgba(0, 0, 0, 0.5);
      border-top-right-radius: 12px;
      border-bottom-right-radius: 12px;
    }
    .sidebar h2 {
      color: #00c4cc;
      font-size: 20px;
      margin: 0 0 15px 0;
      text-align: center;
      text-transform: uppercase;
      letter-spacing: 1.5px;
    }
    .sidebar ul { list-style: none; padding: 0; }
    .sidebar li {
      padding: 12px 15px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s ease;
      border-radius: 6px;
      display: flex;
      align-items: center;
    }
    .sidebar li:hover {
      background: #2d3a42;
      transform: translateX(5px);
      color: #00c4cc;
    }
    .sidebar li::before {
      content: '';
      margin-right: 10px;
      font-size: 16px;
    }
    .sidebar li:nth-child(1)::before { content: '‚úàÔ∏è'; } /* –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –¥—Ä–æ–Ω–∞ */
    .sidebar li:nth-child(2)::before { content: 'üë®‚Äç‚úàÔ∏è'; } /* –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–∏–ª–æ—Ç–∞ */
    .sidebar li:nth-child(3)::before { content: 'üõ´'; } /* –ü–æ–¥–∞—á–∞ –∑–∞—è–≤–∫–∏ –Ω–∞ –ø–æ–ª—ë—Ç */
    .sidebar li:nth-child(4)::before { content: 'üö´'; } /* –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–ø—Ä–µ—Ç–Ω–æ–π –∑–æ–Ω—ã */
    .sidebar li:nth-child(5)::before { content: 'üì°'; } /* –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ */
    .sidebar li:nth-child(6)::before { content: 'üîî'; } /* –û–ø–æ–≤–µ—â–µ–Ω–∏—è */
    .sidebar li:nth-child(7)::before { content: 'üìã'; } /* –ü—Ä–æ—Å–º–æ—Ç—Ä –¥—Ä–æ–Ω–æ–≤ */
    .sidebar li:nth-child(8)::before { content: 'üìã'; } /* –ü—Ä–æ—Å–º–æ—Ç—Ä –ø–∏–ª–æ—Ç–æ–≤ */
    .sidebar li:nth-child(9)::before { content: 'üìã'; } /* –ü—Ä–æ—Å–º–æ—Ç—Ä –∑–æ–Ω */
    .sidebar form { display: none; margin-top: 15px; }
    .sidebar form.active { display: block; }
    .sidebar input, .sidebar select, .sidebar button {
      width: 100%;
      margin: 8px 0;
      padding: 8px;
      background: #2d3a42;
      color: #a3e4db;
      border: 1px solid #00c4cc;
      border-radius: 6px;
      font-size: 12px;
    }
    .sidebar button {
      background: #00c4cc;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    .sidebar button:hover {
      background: #009ba6;
    }
    .list-item {
      padding: 8px 10px;
      border-bottom: 1px solid #00c4cc;
      cursor: default;
    }
    .list-item:hover {
      background: #2d3a42;
    }
    .top-bar {
      position: absolute;
      top: 0;
      right: 0;
      padding: 10px;
      z-index: 1000;
      background: #1e2a32;
      border-radius: 4px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
    }
    .bottom-bar {
      position: absolute;
      bottom: 0;
      right: 0;
      padding: 10px;
      z-index: 1000;
      background: #1e2a32;
      border-radius: 4px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
    }
    .route-point, .no-fly-point { margin: 8px 0; }
    .zoom-controls {
      position: absolute;
      top: 50px;
      right: 10px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    .zoom-controls button {
      background-color: #2d3a42;
      color: #00c4cc;
      border: 1px solid #00c4cc;
      border-radius: 4px;
      width: 30px;
      height: 30px;
      font-size: 18px;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
    }
    .zoom-controls button:hover {
      background-color: #00c4cc;
      color: #0f1a20;
    }
    .layer-btn {
      background-color: #2d3a42;
      color: #00c4cc;
      border: 1px solid #00c4cc;
      border-radius: 4px;
      width: 30px;
      height: 30px;
      font-size: 18px;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .layer-btn:hover {
      background-color: #00c4cc;
      color: #0f1a20;
    }
    .layer-btn.active {
      background-color: #00c4cc;
      color: #0f1a20;
    }
    .leaflet-pane { filter: grayscale(30%) brightness(0.7) hue-rotate(180deg); }
  </style>
</head>
<body>
<div class="sidebar">
  <h2>UTM-—Å–∏—Å—Ç–µ–º–∞</h2>
  <ul>
    <li onclick="showForm('drone-form')">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –¥—Ä–æ–Ω–∞</li>
    <li onclick="showForm('pilot-form')">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–∏–ª–æ—Ç–∞</li>
    <li onclick="showForm('flight-request-form')">–ü–æ–¥–∞—á–∞ –∑–∞—è–≤–∫–∏ –Ω–∞ –ø–æ–ª—ë—Ç</li>
    <li onclick="showForm('no-fly-zone-form')">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–ø—Ä–µ—Ç–Ω–æ–π –∑–æ–Ω—ã</li>
    <li onclick="startMonitoring()">–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥</li>
    <li id="alerts">–û–ø–æ–≤–µ—â–µ–Ω–∏—è: –ù–µ—Ç</li>
    <li onclick="showForm('drone-list')">–ü—Ä–æ—Å–º–æ—Ç—Ä –¥—Ä–æ–Ω–æ–≤</li>
    <li onclick="showForm('pilot-list')">–ü—Ä–æ—Å–º–æ—Ç—Ä –ø–∏–ª–æ—Ç–æ–≤</li>
    <li onclick="showForm('no-fly-list')">–ü—Ä–æ—Å–º–æ—Ç—Ä –∑–æ–Ω</li>
  </ul>
  <form id="drone-form">
    <h3>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –¥—Ä–æ–Ω–∞</h3>
    <input type="text" id="drone-brand" placeholder="–ú–∞—Ä–∫–∞" required>
    <input type="text" id="drone-model" placeholder="–ú–æ–¥–µ–ª—å" required>
    <input type="text" id="drone-serial" placeholder="–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä" required>
    <button type="button" onclick="registerDrone()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
  </form>
  <form id="pilot-form">
    <h3>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–∏–ª–æ—Ç–∞</h3>
    <input type="text" id="pilot-name" placeholder="–§–ò–û" required>
    <input type="text" id="pilot-contact" placeholder="–ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ" required>
    <button type="button" onclick="registerPilot()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
  </form>
  <form id="flight-request-form">
    <h3>–ü–æ–¥–∞—á–∞ –∑–∞—è–≤–∫–∏ –Ω–∞ –ø–æ–ª—ë—Ç</h3>
    <label>–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞: <input type="datetime-local" id="flight-start" required></label>
    <label>–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è: <input type="datetime-local" id="flight-end" required></label>
    <label>–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞: <input type="number" id="flight-max-altitude" placeholder="–º" required></label>
    <label>–í–µ—Å –¥—Ä–æ–Ω–∞: <input type="number" id="drone-weight" placeholder="–∫–≥" required></label>
    <label>–ú–æ–¥–µ–ª—å –ë–í–°:
      <select id="drone-model">
        <option value="mini2">Mini 2</option>
        <option value="other">–î—Ä—É–≥–æ–µ</option>
      </select>
    </label>
    <label>–ü—Ä—è–º–∞—è –≤–∏–¥–∏–º–æ—Å—Ç—å: <input type="checkbox" id="direct-visibility"></label>
    <div id="route-points">
      <p>–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ—á–µ–∫ –º–∞—Ä—à—Ä—É—Ç–∞.</p>
    </div>
    <button type="button" onclick="submitFlightRequest()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ –ø–æ–ª—ë—Ç</button>
    <button type="button" onclick="briefing()">–ë—Ä–∏—Ñ–∏–Ω–≥</button>
    <p id="request-status">–°—Ç–∞—Ç—É—Å: –û–∂–∏–¥–∞–Ω–∏–µ</p>
  </form>
  <form id="no-fly-zone-form">
    <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–ø—Ä–µ—Ç–Ω–æ–π –∑–æ–Ω—ã</h3>
    <div id="no-fly-points">
      <p>–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ—á–µ–∫ –∑–∞–ø—Ä–µ—Ç–Ω–æ–π –∑–æ–Ω—ã.</p>
    </div>
    <button type="button" onclick="saveNoFlyZone()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–æ–Ω—É</button>
    <button type="button" onclick="clearNoFlyZone()">–û—á–∏—Å—Ç–∏—Ç—å –∑–æ–Ω—É</button>
  </form>
  <form id="drone-list">
    <h3>–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥—Ä–æ–Ω—ã</h3>
    <div id="drone-list-items"></div>
  </form>
  <form id="pilot-list">
    <h3>–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–∏–ª–æ—Ç—ã</h3>
    <div id="pilot-list-items"></div>
  </form>
  <form id="no-fly-list">
    <h3>–°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∑–∞–ø—Ä–µ—Ç–Ω—ã–µ –∑–æ–Ω—ã</h3>
    <div id="no-fly-list-items"></div>
  </form>
</div>
<div class="top-bar" id="weather-bar">
  <span>–ü–æ–≥–æ–¥–∞: –ó–∞–≥—Ä—É–∑–∫–∞...</span>
</div>
<div class="bottom-bar" id="coords-bar">
  <span>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: –ó–∞–≥—Ä—É–∑–∫–∞...</span>
</div>
<div id="map"></div>
<div class="zoom-controls">
  <button onclick="map.zoomIn()">+</button>
  <button onclick="map.zoomOut()">‚àí</button>
  <button class="layer-btn" id="osm-btn" onclick="changeMapLayer('openstreetmap')" title="OpenStreetMap">üó∫Ô∏è</button>
  <button class="layer-btn" id="topo-btn" onclick="changeMapLayer('opentopomap')" title="OpenTopoMap">‚õ∞Ô∏è</button>
  <button class="layer-btn" id="terrain-btn" onclick="changeMapLayer('stamen-terrain')" title="Stamen Terrain">üåç</button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ localStorage –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
  let drones = JSON.parse(localStorage.getItem('drones')) || [];
  let pilots = JSON.parse(localStorage.getItem('pilots')) || [];
  let noFlyZones = JSON.parse(localStorage.getItem('noFlyZones')) || [];
  let savedNoFlyPolygons = []; // –ú–∞—Å—Å–∏–≤ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–ª–∏–≥–æ–Ω–æ–≤ –Ω–∞ –∫–∞—Ä—Ç–µ

  const map = L.map('map', {
    zoomControl: false,
    zoom: 10,
    center: [51.1694, 71.4491]
  });

  const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap contributors',
    opacity: 0.5
  });

  const topoLayer = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenTopoMap contributors',
    opacity: 0.5
  });

  const terrainLayer = L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/terrain/{z}/{x}/{y}.png', {
    attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, under <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a>. Data by <a href="http://openstreetmap.org">OpenStreetMap</a>, under ODbL.',
    opacity: 0.5
  });

  osmLayer.addTo(map);

  let noFlyZone = null;
  const noFlyPoints = [];
  let noFlyMarkers = [];

  let routePath = null;
  const routePoints = [];
  let routeMarkers = [];

  let droneMarker = null;
  let isMonitoring = false;
  let currentLayer = 'openstreetmap';

  document.getElementById('osm-btn').classList.add('active');

  // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –∑–æ–Ω –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
  function renderSavedNoFlyZones() {
    savedNoFlyPolygons.forEach(polygon => map.removeLayer(polygon));
    savedNoFlyPolygons = noFlyZones.map(zone =>
            L.polygon(zone.points, {
              color: '#ff0000',
              fillColor: '#ff0000',
              fillOpacity: 0.2,
              id: zone.id
            }).addTo(map)
    );
  }

  map.on('click', function(e) {
    const latlng = e.latlng;

    const noFlyForm = document.getElementById('no-fly-zone-form');
    if (noFlyForm && noFlyForm.classList.contains('active')) {
      noFlyPoints.push([latlng.lat, latlng.lng]);

      const pointDiv = document.createElement('div');
      pointDiv.className = 'no-fly-point';
      pointDiv.innerHTML = `–¢–æ—á–∫–∞: [${latlng.lat.toFixed(4)}, ${latlng.lng.toFixed(4)}]`;
      document.getElementById('no-fly-points').appendChild(pointDiv);

      const marker = L.marker([latlng.lat, latlng.lng], {
        icon: L.divIcon({ className: 'no-fly-marker', html: '<div style="background: red; width: 10px; height: 10px; border-radius: 50%;"></div>' })
      }).addTo(map);
      noFlyMarkers.push(marker);

      if (noFlyZone) map.removeLayer(noFlyZone);
      if (noFlyPoints.length >= 3) {
        noFlyZone = L.polygon(noFlyPoints, {
          color: '#ff0000',
          fillColor: '#ff0000',
          fillOpacity: 0.2
        }).addTo(map);
      }
    } else {
      const flightForm = document.getElementById('flight-request-form');
      if (flightForm && flightForm.classList.contains('active')) {
        routePoints.push([latlng.lat, latlng.lng]);

        const pointDiv = document.createElement('div');
        pointDiv.className = 'route-point';
        pointDiv.innerHTML = `–¢–æ—á–∫–∞: [${latlng.lat.toFixed(4)}, ${latlng.lng.toFixed(4)}]`;
        document.getElementById('route-points').appendChild(pointDiv);

        const marker = L.marker([latlng.lat, latlng.lng], {
          icon: L.divIcon({ className: 'route-marker', html: '<div style="background: #00c4cc; width: 10px; height: 10px; border-radius: 50%;"></div>' })
        }).addTo(map);
        routeMarkers.push(marker);

        if (routePath) map.removeLayer(routePath);
        routePath = L.polyline(routePoints, { color: '#00c4cc', weight: 3 }).addTo(map);
      }
    }
  });

  function showForm(formId) {
    const forms = document.querySelectorAll('.sidebar form');
    if (!forms) return;
    forms.forEach(form => {
      form.classList.remove('active');
    });
    const form = document.getElementById(formId);
    if (form) form.classList.add('active');
    if (formId === 'drone-list') updateDroneList();
    if (formId === 'pilot-list') updatePilotList();
    if (formId === 'no-fly-list') updateNoFlyList();
    routePoints.length = 0;
    routeMarkers.forEach(marker => map.removeLayer(marker));
    routeMarkers = [];
    if (routePath) map.removeLayer(routePath);
    const routePointsDiv = document.getElementById('route-points');
    if (routePointsDiv) routePointsDiv.innerHTML = '<p>–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ—á–µ–∫ –º–∞—Ä—à—Ä—É—Ç–∞.</p>';
  }

  function registerDrone() {
    const brand = document.getElementById('drone-brand').value;
    const model = document.getElementById('drone-model').value;
    const serial = document.getElementById('drone-serial').value;
    if (brand && model && serial) {
      const drone = { brand, model, serial };
      drones.push(drone);
      localStorage.setItem('drones', JSON.stringify(drones));
      alert(`–î—Ä–æ–Ω –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω: ${brand} ${model}, —Å–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä: ${serial}`);
      document.getElementById('drone-brand').value = '';
      document.getElementById('drone-model').value = '';
      document.getElementById('drone-serial').value = '';
    } else {
      alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!');
    }
  }

  function registerPilot() {
    const name = document.getElementById('pilot-name').value;
    const contact = document.getElementById('pilot-contact').value;
    if (name && contact) {
      const pilot = { name, contact };
      pilots.push(pilot);
      localStorage.setItem('pilots', JSON.stringify(pilots));
      alert(`–ü–∏–ª–æ—Ç –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω: ${name}, –∫–æ–Ω—Ç–∞–∫—Ç: ${contact}`);
      document.getElementById('pilot-name').value = '';
      document.getElementById('pilot-contact').value = '';
    } else {
      alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!');
    }
  }

  function submitFlightRequest() {
    const start = document.getElementById('flight-start').value;
    const end = document.getElementById('flight-end').value;
    const maxAltitude = document.getElementById('flight-max-altitude').value;
    const droneWeight = document.getElementById('drone-weight').value;
    const droneModel = document.getElementById('drone-model').value;
    const directVisibility = document.getElementById('direct-visibility').checked ? 1 : 0;

    if (routePoints.length < 2) {
      alert('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –¥–≤–µ —Ç–æ—á–∫–∏ –º–∞—Ä—à—Ä—É—Ç–∞!');
      return;
    }

    let inNoFlyZone = false;

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–µ–π –∑–∞–ø—Ä–µ—Ç–Ω–æ–π –∑–æ–Ω—ã (–µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å)
    if (noFlyZone) {
      routePoints.forEach(point => {
        if (isPointInPolygon(point, noFlyPoints)) {
          inNoFlyZone = true;
        }
      });
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –∑–∞–ø—Ä–µ—Ç–Ω—ã—Ö –∑–æ–Ω
    noFlyZones.forEach(zone => {
      routePoints.forEach(point => {
        if (isPointInPolygon(point, zone.points)) {
          inNoFlyZone = true;
        }
      });
    });

    const status = inNoFlyZone ? '–æ—Ç–∫–ª–æ–Ω–µ–Ω–æ (–º–∞—Ä—à—Ä—É—Ç –ø–µ—Ä–µ—Å–µ–∫–∞–µ—Ç –∑–∞–ø—Ä–µ—Ç–Ω—É—é –∑–æ–Ω—É)' : '–æ–¥–æ–±—Ä–µ–Ω–æ';
    document.getElementById('request-status').textContent = `–°—Ç–∞—Ç—É—Å: ${status}`;
    routePoints.length = 0;
    routeMarkers.forEach(marker => map.removeLayer(marker));
    routeMarkers = [];
    if (routePath) map.removeLayer(routePath);
    const routePointsDiv = document.getElementById('route-points');
    if (routePointsDiv) routePointsDiv.innerHTML = '<p>–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ—á–µ–∫ –º–∞—Ä—à—Ä—É—Ç–∞.</p>';
  }

  function briefing() {
    alert('–ë—Ä–∏—Ñ–∏–Ω–≥: –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ –ø–æ–ª—ë—Ç–æ–º. –í—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ –Ω–æ—Ä–º–µ.');
  }

  function saveNoFlyZone() {
    if (noFlyPoints.length >= 3) {
      const zone = { points: [...noFlyPoints], id: Date.now() };
      noFlyZones.push(zone);
      localStorage.setItem('noFlyZones', JSON.stringify(noFlyZones));
      renderSavedNoFlyZones(); // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –Ω–æ–≤–æ–π –∑–æ–Ω—ã –Ω–∞ –∫–∞—Ä—Ç–µ
      updateNoFlyList();
      alert('–ó–∞–ø—Ä–µ—Ç–Ω–∞—è –∑–æ–Ω–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!');
      clearNoFlyZone();
    } else {
      alert('–î–æ–±–∞–≤—å—Ç–µ –º–∏–Ω–∏–º—É–º 3 —Ç–æ—á–∫–∏ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–æ–Ω—ã!');
    }
  }

  function clearNoFlyZone() {
    noFlyPoints.length = 0;
    noFlyMarkers.forEach(marker => map.removeLayer(marker));
    noFlyMarkers = [];
    if (noFlyZone) {
      map.removeLayer(noFlyZone);
      noFlyZone = null;
    }
    const noFlyPointsDiv = document.getElementById('no-fly-points');
    if (noFlyPointsDiv) noFlyPointsDiv.innerHTML = '<p>–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ—á–µ–∫ –∑–∞–ø—Ä–µ—Ç–Ω–æ–π –∑–æ–Ω—ã.</p>';
  }

  function updateDroneList() {
    const list = document.getElementById('drone-list-items');
    list.innerHTML = '';
    drones.forEach(drone => {
      const item = document.createElement('div');
      item.className = 'list-item';
      item.textContent = `${drone.brand} ${drone.model}, –°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä: ${drone.serial}`;
      list.appendChild(item);
    });
  }

  function updatePilotList() {
    const list = document.getElementById('pilot-list-items');
    list.innerHTML = '';
    pilots.forEach(pilot => {
      const item = document.createElement('div');
      item.className = 'list-item';
      item.textContent = `${pilot.name}, –ö–æ–Ω—Ç–∞–∫—Ç: ${pilot.contact}`;
      list.appendChild(item);
    });
  }

  function updateNoFlyList() {
    const list = document.getElementById('no-fly-list-items');
    list.innerHTML = '';
    noFlyZones.forEach(zone => {
      const item = document.createElement('div');
      item.className = 'list-item';
      item.textContent = `–ó–æ–Ω–∞ #${zone.id}: ${zone.points.length} —Ç–æ—á–µ–∫`;
      list.appendChild(item);
    });
  }

  function changeMapLayer(layer) {
    if (currentLayer === layer) return;

    const layerButtons = document.querySelectorAll('.layer-btn');
    if (layerButtons) {
      layerButtons.forEach(btn => btn.classList.remove('active'));
    }

    const activeButton = document.getElementById(`${layer}-btn`);
    if (activeButton) activeButton.classList.add('active');

    map.eachLayer(function (layer) {
      // –£–¥–∞–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Å–ª–æ–∏ –∫–∞—Ä—Ç—ã (TileLayer), –æ—Å—Ç–∞–≤–ª—è—è –º–∞—Ä–∫–µ—Ä—ã, –ø–æ–ª–∏–≥–æ–Ω—ã –∏ –ª–∏–Ω–∏–∏
      if (layer instanceof L.TileLayer) {
        map.removeLayer(layer);
      }
    });

    if (layer === 'openstreetmap') osmLayer.addTo(map);
    else if (layer === 'opentopomap') topoLayer.addTo(map);
    else if (layer === 'stamen-terrain') terrainLayer.addTo(map);

    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –∑–æ–Ω –Ω–∞ –Ω–æ–≤—ã–π —Å–ª–æ–π
    renderSavedNoFlyZones();
    if (noFlyZone) noFlyZone.addTo(map);
    noFlyMarkers.forEach(marker => marker.addTo(map));
    if (routePath) routePath.addTo(map);
    routeMarkers.forEach(marker => marker.addTo(map));
    if (droneMarker) droneMarker.addTo(map);

    currentLayer = layer;
  }

  function isPointInPolygon(point, polygon) {
    let inside = false;
    for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
      const xi = polygon[i][0], yi = polygon[i][1];
      const xj = polygon[j][0], yj = polygon[j][1];
      const x = point[0], y = point[1];

      const intersect = ((yi > y) !== (yj > y)) && (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
      if (intersect) inside = !inside;
    }
    return inside;
  }

  function startMonitoring() {
    if (routePoints.length < 2) {
      alert('–°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∞–π—Ç–µ –∑–∞—è–≤–∫—É –Ω–∞ –ø–æ–ª—ë—Ç —Å –º–∏–Ω–∏–º—É–º –¥–≤—É–º—è —Ç–æ—á–∫–∞–º–∏!');
      return;
    }

    if (document.getElementById('request-status').textContent.includes('–æ—Ç–∫–ª–æ–Ω–µ–Ω–æ')) {
      alert('–ó–∞—è–≤–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞, –ø–æ–ª—ë—Ç –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω!');
      return;
    }

    if (isMonitoring) return;
    isMonitoring = true;

    if (droneMarker) map.removeLayer(droneMarker);
    let currentIndex = 0;
    droneMarker = L.marker(routePoints[0]).addTo(map)
            .bindPopup('–î—Ä–æ–Ω: –í –ø–æ–ª—ë—Ç–µ');

    const moveDrone = () => {
      if (!isMonitoring || currentIndex >= routePoints.length - 1) {
        isMonitoring = false;
        return;
      }

      currentIndex++;
      droneMarker.setLatLng(routePoints[currentIndex]);

      let inNoFlyZone = false;
      if (noFlyZone) {
        if (isPointInPolygon(routePoints[currentIndex], noFlyPoints)) {
          inNoFlyZone = true;
        }
      }
      noFlyZones.forEach(zone => {
        if (isPointInPolygon(routePoints[currentIndex], zone.points)) {
          inNoFlyZone = true;
        }
      });

      if (inNoFlyZone) {
        document.getElementById('alerts').textContent = '–û–ø–æ–≤–µ—â–µ–Ω–∏—è: –í—Ö–æ–¥ –≤ –∑–∞–ø—Ä–µ—Ç–Ω—É—é –∑–æ–Ω—É!';
      } else {
        document.getElementById('alerts').textContent = '–û–ø–æ–≤–µ—â–µ–Ω–∏—è: –ù–µ—Ç';
      }

      setTimeout(moveDrone, 2000);
    };

    moveDrone();
  }

  async function fetchWeather() {
    try {
      const response = await fetch('https://api.openweathermap.org/data/2.5/weather?lat=51.1694&lon=71.4491&appid=00150018ecbe7940cdd3818ae9c549f4&units=metric');
      if (!response.ok) {
        throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø–æ–≥–æ–¥—ã: ' + response.statusText);
      }
      const data = await response.json();
      const temp = data.main.temp;
      const wind = data.wind.speed;
      document.getElementById('weather-bar').innerHTML = `–ü–æ–≥–æ–¥–∞: +${temp.toFixed(0)}¬∞C, –í–µ—Ç–µ—Ä: ${wind.toFixed(1)} –º/—Å`;
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø–æ–≥–æ–¥—ã:', error);
      document.getElementById('weather-bar').innerHTML = '–ü–æ–≥–æ–¥–∞: –ù/–î';
    }
  }
  fetchWeather();
  renderSavedNoFlyZones(); // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –∑–æ–Ω –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ

  function toDMS(coord, isLat) {
    const deg = Math.floor(coord);
    const min = Math.floor((coord - deg) * 60);
    const sec = ((coord - deg - min / 60) * 3600).toFixed(0);
    return `${deg}¬∞${min}'${sec}"${isLat ? (coord >= 0 ? 'N' : 'S') : (coord >= 0 ? 'E' : 'W')}`;
  }

  map.on('move', () => {
    const center = map.getCenter();
    const lat = toDMS(center.lat, true);
    const lng = toDMS(center.lng, false);
    document.getElementById('coords-bar').innerHTML = `–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${lat} ${lng}`;
  });
</script>
</body>
</html>