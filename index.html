<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>UTM-—Å–∏—Å—Ç–µ–º–∞ –¥–ª—è –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #0d1b26, #1a2e44);
      color: #e0f7fa;
      overflow: hidden;
    }
    #map {
      height: 100vh;
      width: 100%;
      transition: filter 0.3s ease;
    }
    .sidebar {
      position: absolute;
      left: 0;
      top: 0;
      width: 320px;
      height: 100vh;
      background: linear-gradient(160deg, #1a2e44, #0d1b26);
      padding: 20px;
      z-index: 1000;
      overflow-y: auto;
      border-right: 3px solid #00d4cc;
      box-shadow: 4px 0 15px rgba(0, 0, 0, 0.6);
      border-top-right-radius: 15px;
      border-bottom-right-radius: 15px;
      animation: slideIn 0.5s ease-out;
    }
    @keyframes slideIn {
      from { transform: translateX(-100%); }
      to { transform: translateX(0); }
    }
    .sidebar h2 {
      color: #00d4cc;
      font-size: 24px;
      margin: 0 0 20px 0;
      text-align: center;
      text-transform: uppercase;
      letter-spacing: 2px;
      font-weight: 600;
    }
    .sidebar ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .sidebar li {
      display: flex;
      align-items: center;
      flex-direction: column;
      color: #a3e4db;
      font-size: 16px;
    }
    .menu-label {
      display: flex;
      align-items: center;
      padding: 15px 20px;
      cursor: pointer;
      width: 100%;
      border-radius: 8px;
      transition: all 0.3s ease;
    }
    .menu-label:hover {
      background: #2d4a66;
      transform: translateX(10px);
      color: #fff;
    }
    .menu-label::before {
      content: '';
      margin-right: 12px;
      font-size: 18px;
      transition: transform 0.3s ease;
    }
    .menu-label:hover::before {
      transform: scale(1.2);
    }
    .sidebar li:nth-child(1) .menu-label::before { content: '‚úàÔ∏è'; }
    .sidebar li:nth-child(2) .menu-label::before { content: 'üë®‚Äç‚úàÔ∏è'; }
    .sidebar li:nth-child(3) .menu-label::before { content: 'üõ´'; }
    .sidebar li:nth-child(4) .menu-label::before { content: 'üö´'; }
    .sidebar li:nth-child(5) .menu-label::before { content: 'üì°'; }
    .sidebar li:nth-child(6) .menu-label::before { content: 'üîî'; }
    .sidebar li:nth-child(7) .menu-label::before { content: 'üìã'; }
    .sidebar li:nth-child(8) .menu-label::before { content: 'üìã'; }
    .sidebar li:nth-child(9) .menu-label::before { content: 'üìã'; }
    .sidebar li:nth-child(10) .menu-label::before { content: 'üìã'; }
    .sidebar form {
      display: none;
      margin-top: 10px;
      padding: 10px;
      background: #2d4a66;
      border-radius: 8px;
      animation: fadeIn 0.3s ease-in;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .sidebar form.active {
      display: block;
    }
    .sidebar input, .sidebar select, .sidebar button {
      width: 100%;
      margin: 10px 0;
      padding: 10px;
      background: #1a2e44;
      color: #e0f7fa;
      border: 2px solid #00d4cc;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.3s ease;
    }
    .sidebar input:focus, .sidebar select:focus {
      border-color: #00a8a0;
      outline: none;
      background: #3d5f7d;
    }
    .sidebar button {
      background: #00d4cc;
      cursor: pointer;
      transition: background 0.3s ease, transform 0.2s ease;
      width: auto;
      padding: 8px 15px;
      font-weight: 500;
    }
    .sidebar button:hover {
      background: #00a8a0;
      transform: scale(1.05);
    }
    .list-item {
      padding: 10px 15px;
      border-bottom: 1px solid #00d4cc;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background 0.3s ease;
    }
    .list-item:hover {
      background: #3d5f7d;
    }
    .list-item span {
      cursor: pointer;
      flex-grow: 1;
      transition: color 0.3s ease;
    }
    .list-item span:hover {
      color: #00d4cc;
    }
    .top-bar {
      position: absolute;
      top: 10px;
      right: 10px;
      padding: 12px 20px;
      z-index: 1000;
      background: rgba(26, 46, 68, 0.9);
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(5px);
      transition: transform 0.3s ease;
    }
    .top-bar:hover {
      transform: scale(1.05);
    }
    .bottom-bar {
      position: absolute;
      bottom: 10px;
      right: 10px;
      padding: 12px 20px;
      z-index: 1000;
      background: rgba(26, 46, 68, 0.9);
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(5px);
      transition: transform 0.3s ease;
    }
    .bottom-bar:hover {
      transform: scale(1.05);
    }
    .route-point, .no-fly-point { margin: 10px 0; }
    .zoom-controls {
      position: absolute;
      top: 60px;
      right: 10px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .zoom-controls button {
      background-color: #2d4a66;
      color: #00d4cc;
      border: 2px solid #00d4cc;
      border-radius: 6px;
      width: 40px;
      height: 40px;
      font-size: 20px;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
      transition: all 0.3s ease;
    }
    .zoom-controls button:hover {
      background-color: #00d4cc;
      color: #1a2e44;
      transform: scale(1.1);
    }
    .layer-btn {
      background-color: #2d4a66;
      color: #00d4cc;
      border: 2px solid #00d4cc;
      border-radius: 6px;
      width: 40px;
      height: 40px;
      font-size: 20px;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }
    .layer-btn:hover {
      background-color: #00d4cc;
      color: #1a2e44;
    }
    .layer-btn.active {
      background-color: #00d4cc;
      color: #1a2e44;
    }
    .role-switch {
      margin: 15px 0;
      display: flex;
      justify-content: center;
      gap: 10px;
      padding: 10px;
      background: linear-gradient(90deg, #1a2e44, #2d4a66);
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0, 212, 204, 0.2);
    }
    .role-btn {
      padding: 8px 20px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      background: linear-gradient(135deg, #00d4cc, #00a8a0);
      color: #1a2e44;
      transition: all 0.3s ease;
      box-shadow: 0 2px 10px rgba(0, 212, 204, 0.3);
      position: relative;
      overflow: hidden;
    }
    .role-btn::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      transition: width 0.4s ease, height 0.4s ease;
    }
    .role-btn:hover::after {
      width: 200px;
      height: 200px;
    }
    .role-btn.active {
      background: linear-gradient(135deg, #00a8a0, #00d4cc);
      transform: scale(1.05);
      box-shadow: 0 4px 20px rgba(0, 212, 204, 0.5);
    }
    .role-btn:disabled {
      background: #3d5f7d;
      cursor: not-allowed;
      color: #a3e4db;
    }
    .leaflet-pane { filter: grayscale(20%) brightness(0.8); }
    .menu-item {
      display: flex;
      flex-direction: column;
      width: 100%;
    }
  </style>
</head>
<body>
<div class="sidebar">
  <h2>UTM-—Å–∏—Å—Ç–µ–º–∞</h2>
  <div class="role-switch" id="role-switch">
    <button class="role-btn" onclick="setRole('user')">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</button>
    <button class="role-btn" onclick="setRole('admin')">–ê–¥–º–∏–Ω</button>
  </div>
  <ul>
    <li class="menu-item">
      <div class="menu-label" onclick="showForm('drone-form')">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –¥—Ä–æ–Ω–∞</div>
      <form id="drone-form">
        <h3>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –¥—Ä–æ–Ω–∞</h3>
        <input type="text" id="drone-brand" placeholder="–ú–∞—Ä–∫–∞" required>
        <input type="text" id="drone-model" placeholder="–ú–æ–¥–µ–ª—å" required>
        <input type="text" id="drone-serial" placeholder="–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä" required>
        <button type="button" onclick="registerDrone()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
      </form>
    </li>
    <li class="menu-item">
      <div class="menu-label" onclick="showForm('pilot-form')">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–∏–ª–æ—Ç–∞</div>
      <form id="pilot-form">
        <h3>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–∏–ª–æ—Ç–∞</h3>
        <input type="text" id="pilot-name" placeholder="–§–ò–û" required>
        <input type="text" id="pilot-contact" placeholder="–ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ" required>
        <button type="button" onclick="registerPilot()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
      </form>
    </li>
    <li class="menu-item">
      <div class="menu-label" onclick="showForm('flight-request-form')">–ü–æ–¥–∞—á–∞ –∑–∞—è–≤–∫–∏ –Ω–∞ –ø–æ–ª—ë—Ç</div>
      <form id="flight-request-form">
        <h3>–ü–æ–¥–∞—á–∞ –∑–∞—è–≤–∫–∏ –Ω–∞ –ø–æ–ª—ë—Ç</h3>
        <label>–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞: <input type="datetime-local" id="flight-start" required></label>
        <label>–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è: <input type="datetime-local" id="flight-end" required></label>
        <label>–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞: <input type="number" id="flight-max-altitude" placeholder="–º" required></label>
        <label>–í–µ—Å –¥—Ä–æ–Ω–∞: <input type="number" id="drone-weight" placeholder="–∫–≥" required></label>
        <label>–ú–æ–¥–µ–ª—å –ë–í–°:
          <select id="drone-model-select">
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –¥—Ä–æ–Ω</option>
          </select>
        </label>
        <label>–ü–∏–ª–æ—Ç:
          <select id="pilot-select">
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–∏–ª–æ—Ç–∞</option>
          </select>
        </label>
        <label>–ü—Ä—è–º–∞—è –≤–∏–¥–∏–º–æ—Å—Ç—å: <input type="checkbox" id="direct-visibility"></label>
        <label>–¢–∏–ø –º–∞—Ä—à—Ä—É—Ç–∞:</label>
        <label><input type="radio" name="route-type" value="points" checked onclick="toggleRouteType()"> –¢–æ—á–∫–∏</label>
        <label><input type="radio" name="route-type" value="circle" onclick="toggleRouteType()"> –ö—Ä—É–≥</label>
        <div id="route-points" class="route-input active">
          <p>–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ—á–µ–∫ –º–∞—Ä—à—Ä—É—Ç–∞.</p>
        </div>
        <div id="route-circle" class="route-input">
          <p>–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ü–µ–Ω—Ç—Ä–∞ –∫—Ä—É–≥–∞.</p>
          <label>–†–∞–¥–∏—É—Å (–º): <input type="number" id="circle-radius" placeholder="–†–∞–¥–∏—É—Å –≤ –º–µ—Ç—Ä–∞—Ö" min="10"></label>
        </div>
        <button type="button" onclick="submitFlightRequest()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ –ø–æ–ª—ë—Ç</button>
        <button type="button" onclick="briefing()">–ë—Ä–∏—Ñ–∏–Ω–≥</button>
        <p id="request-status">–°—Ç–∞—Ç—É—Å: –û–∂–∏–¥–∞–Ω–∏–µ</p>
      </form>
    </li>
    <li class="menu-item">
      <div class="menu-label" onclick="showForm('no-fly-zone-form')">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–ø—Ä–µ—Ç–Ω–æ–π –∑–æ–Ω—ã</div>
      <form id="no-fly-zone-form">
        <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–ø—Ä–µ—Ç–Ω–æ–π –∑–æ–Ω—ã</h3>
        <div id="no-fly-points">
          <p>–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ—á–µ–∫ –∑–∞–ø—Ä–µ—Ç–Ω–æ–π –∑–æ–Ω—ã.</p>
        </div>
        <button type="button" onclick="saveNoFlyZone()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–æ–Ω—É</button>
        <button type="button" onclick="clearNoFlyZone()">–û—á–∏—Å—Ç–∏—Ç—å –∑–æ–Ω—É</button>
      </form>
    </li>
    <li class="menu-item">
      <div class="menu-label" onclick="startMonitoring()">–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥</div>
    </li>
    <li class="menu-item">
      <div class="menu-label" id="alerts">–û–ø–æ–≤–µ—â–µ–Ω–∏—è: –ù–µ—Ç</div>
    </li>
    <li class="menu-item">
      <div class="menu-label" onclick="showForm('drone-list')">–ü—Ä–æ—Å–º–æ—Ç—Ä –¥—Ä–æ–Ω–æ–≤</div>
      <form id="drone-list">
        <h3>–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥—Ä–æ–Ω—ã</h3>
        <div id="drone-list-items"></div>
      </form>
    </li>
    <li class="menu-item">
      <div class="menu-label" onclick="showForm('pilot-list')">–ü—Ä–æ—Å–º–æ—Ç—Ä –ø–∏–ª–æ—Ç–æ–≤</div>
      <form id="pilot-list">
        <h3>–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–∏–ª–æ—Ç—ã</h3>
        <div id="pilot-list-items"></div>
      </form>
    </li>
    <li class="menu-item">
      <div class="menu-label" onclick="showForm('no-fly-list')">–ü—Ä–æ—Å–º–æ—Ç—Ä –∑–æ–Ω</div>
      <form id="no-fly-list">
        <h3>–°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∑–∞–ø—Ä–µ—Ç–Ω—ã–µ –∑–æ–Ω—ã</h3>
        <div id="no-fly-list-items"></div>
      </form>
    </li>
    <li class="menu-item">
      <div class="menu-label" onclick="showForm('flight-session-list')">–ü—Ä–æ—Å–º–æ—Ç—Ä —Å–µ—Å—Å–∏–π</div>
      <form id="flight-session-list">
        <h3>–ü–æ–ª—ë—Ç–Ω—ã–µ —Å–µ—Å—Å–∏–∏</h3>
        <div id="flight-session-list-items"></div>
      </form>
    </li>
  </ul>
</div>
<div class="top-bar" id="weather-bar">
  <span>–ü–æ–≥–æ–¥–∞: –ó–∞–≥—Ä—É–∑–∫–∞...</span>
</div>
<div class="bottom-bar" id="coords-bar">
  <span>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: –ó–∞–≥—Ä—É–∑–∫–∞...</span>
</div>
<div id="map"></div>
<div class="zoom-controls">
  <button onclick="map.zoomIn()">+</button>
  <button onclick="map.zoomOut()">‚àí</button>
  <button class="layer-btn" id="osm-btn" onclick="changeMapLayer('openstreetmap')" title="OpenStreetMap">üó∫Ô∏è</button>
  <button class="layer-btn" id="topo-btn" onclick="changeMapLayer('opentopomap')" title="OpenTopoMap">‚õ∞Ô∏è</button>
  <button class="layer-btn" id="terrain-btn" onclick="changeMapLayer('stamen-terrain')" title="Stamen Terrain">üåç</button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ localStorage –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
  let drones = JSON.parse(localStorage.getItem('drones')) || [];
  let pilots = JSON.parse(localStorage.getItem('pilots')) || [];
  let noFlyZones = JSON.parse(localStorage.getItem('noFlyZones')) || [];
  let flightSessions = JSON.parse(localStorage.getItem('flightSessions')) || [];
  let savedNoFlyPolygons = [];
  let currentRoutePath = null;
  let userRole = localStorage.getItem('userRole') || 'user';

  const map = L.map('map', {
    zoomControl: false,
    zoom: 10,
    center: [51.1694, 71.4491]
  });

  const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap contributors',
    opacity: 0.5
  });

  const topoLayer = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenTopoMap contributors',
    opacity: 0.5
  });

  const terrainLayer = L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/terrain/{z}/{x}/{y}.png', {
    attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, under <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a>. Data by <a href="http://openstreetmap.org">OpenStreetMap</a>, under ODbL.',
    opacity: 0.5
  });

  osmLayer.addTo(map);

  let noFlyZone = null;
  const noFlyPoints = [];
  let noFlyMarkers = [];

  let routePath = null;
  const routePoints = [];
  let routeMarkers = [];
  let circleCenter = null;
  let circleOverlay = null;

  let droneMarker = null;
  let isMonitoring = false;
  let currentLayer = 'openstreetmap';
  let lastWeatherUpdate = 0;

  document.getElementById('osm-btn').classList.add('active');

  function setRole(role) {
    userRole = role;
    localStorage.setItem('userRole', role);
    updateRoleButtons();
  }

  function updateRoleButtons() {
    const buttons = document.querySelectorAll('.role-btn');
    buttons.forEach(btn => {
      btn.classList.remove('active');
      if (btn.textContent === userRole === 'user' ? '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å' : '–ê–¥–º–∏–Ω') {
        btn.classList.add('active');
      }
    });
  }

  updateRoleButtons();

  function updateDropdowns() {
    const droneSelect = document.getElementById('drone-model-select');
    const pilotSelect = document.getElementById('pilot-select');
    droneSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –¥—Ä–æ–Ω</option>';
    pilotSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–∏–ª–æ—Ç–∞</option>';

    drones.forEach(drone => {
      const option = document.createElement('option');
      option.value = drone.serial;
      option.text = `${drone.brand} ${drone.model} (–°–ù: ${drone.serial})`;
      droneSelect.appendChild(option);
    });

    pilots.forEach(pilot => {
      const option = document.createElement('option');
      option.value = pilot.contact;
      option.text = `${pilot.name} (–ö–æ–Ω—Ç–∞–∫—Ç: ${pilot.contact})`;
      pilotSelect.appendChild(option);
    });
  }

  function updateDroneList() {
    const list = document.getElementById('drone-list-items');
    list.innerHTML = '';
    drones.forEach(drone => {
      const item = document.createElement('div');
      item.className = 'list-item';
      const text = document.createElement('span');
      text.textContent = `${drone.brand} ${drone.model}, –°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä: ${drone.serial}`;
      const deleteButton = document.createElement('button');
      deleteButton.textContent = '–£–¥–∞–ª–∏—Ç—å';
      deleteButton.onclick = () => deleteDrone(drone.serial);
      item.appendChild(text);
      item.appendChild(deleteButton);
      list.appendChild(item);
    });
  }

  function updatePilotList() {
    const list = document.getElementById('pilot-list-items');
    list.innerHTML = '';
    pilots.forEach(pilot => {
      const item = document.createElement('div');
      item.className = 'list-item';
      const text = document.createElement('span');
      text.textContent = `${pilot.name}, –ö–æ–Ω—Ç–∞–∫—Ç: ${pilot.contact}`;
      const deleteButton = document.createElement('button');
      deleteButton.textContent = '–£–¥–∞–ª–∏—Ç—å';
      deleteButton.onclick = () => deletePilot(pilot.contact);
      item.appendChild(text);
      item.appendChild(deleteButton);
      list.appendChild(item);
    });
  }

  function updateNoFlyList() {
    const list = document.getElementById('no-fly-list-items');
    list.innerHTML = '';
    noFlyZones.forEach(zone => {
      const item = document.createElement('div');
      item.className = 'list-item';
      const text = document.createElement('span');
      text.textContent = `–ó–æ–Ω–∞ #${zone.id}: ${zone.points.length} —Ç–æ—á–µ–∫`;
      const deleteButton = document.createElement('button');
      deleteButton.textContent = '–£–¥–∞–ª–∏—Ç—å';
      deleteButton.onclick = () => deleteNoFlyZone(zone.id);
      item.appendChild(text);
      item.appendChild(deleteButton);
      list.appendChild(item);
    });
  }

  function updateFlightSessionList() {
    const list = document.getElementById('flight-session-list-items');
    list.innerHTML = '';
    flightSessions.forEach(session => {
      const item = document.createElement('div');
      item.className = 'list-item';
      const text = document.createElement('span');
      text.textContent = `–°–µ—Å—Å–∏—è #${session.flightSessionId}: –î—Ä–æ–Ω: ${session.drone.brand} ${session.drone.model}, –ü–∏–ª–æ—Ç: ${session.pilot.name}, –°—Ç–∞—Ç—É—Å: ${session.status}, –í—Ä–µ–º—è: ${session.timestamp}`;
      text.onclick = () => renderSessionRoute(session.flightSessionId);
      const deleteButton = document.createElement('button');
      deleteButton.textContent = '–£–¥–∞–ª–∏—Ç—å';
      deleteButton.onclick = () => deleteFlightSession(session.flightSessionId);
      item.appendChild(text);
      item.appendChild(deleteButton);
      list.appendChild(item);
    });
  }

  function renderSessionRoute(flightSessionId) {
    if (currentRoutePath) {
      map.removeLayer(currentRoutePath);
      currentRoutePath = null;
    }

    if (flightSessionId) {
      const session = flightSessions.find(s => s.flightSessionId === flightSessionId);
      if (session && session.routePoints && session.routePoints.length > 0) {
        currentRoutePath = L.polyline(session.routePoints, {
          color: '#00d4cc',
          weight: 3
        }).addTo(map);
        map.fitBounds(L.latLngBounds(session.routePoints));
      }
    }
  }

  function renderSavedNoFlyZones() {
    savedNoFlyPolygons.forEach(polygon => map.removeLayer(polygon));
    savedNoFlyPolygons = noFlyZones.map(zone =>
            L.polygon(zone.points, {
              color: '#ff4d4d',
              fillColor: '#ff4d4d',
              fillOpacity: 0.2,
              id: zone.id
            }).addTo(map)
    );
  }

  function toggleRouteType() {
    const routeType = document.querySelector('input[name="route-type"]:checked').value;
    document.getElementById('route-points').classList.toggle('active', routeType === 'points');
    document.getElementById('route-circle').classList.toggle('active', routeType === 'circle');

    routePoints.length = 0;
    routeMarkers.forEach(marker => map.removeLayer(marker));
    routeMarkers = [];
    if (routePath) {
      map.removeLayer(routePath);
      routePath = null;
    }
    if (circleOverlay) {
      map.removeLayer(circleOverlay);
      circleOverlay = null;
    }
    circleCenter = null;

    const routePointsDiv = document.getElementById('route-points');
    if (routePointsDiv) routePointsDiv.innerHTML = '<p>–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ—á–µ–∫ –º–∞—Ä—à—Ä—É—Ç–∞.</p>';
    const routeCircleDiv = document.getElementById('route-circle');
    if (routeCircleDiv) routeCircleDiv.innerHTML = '<p>–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ü–µ–Ω—Ç—Ä–∞ –∫—Ä—É–≥–∞.</p><label>–†–∞–¥–∏—É—Å (–º): <input type="number" id="circle-radius" placeholder="–†–∞–¥–∏—É—Å –≤ –º–µ—Ç—Ä–∞—Ö" min="10"></label>';
  }

  function generateCirclePoints(center, radius, numPoints = 36) {
    const points = [];
    const R = 6378137;
    const lat = center.lat * Math.PI / 180;
    const lng = center.lng * Math.PI / 180;

    for (let i = 0; i < numPoints; i++) {
      const bearing = (i * 360 / numPoints) * Math.PI / 180;
      const lat2 = Math.asin(Math.sin(lat) * Math.cos(radius / R) + Math.cos(lat) * Math.sin(radius / R) * Math.cos(bearing));
      const lng2 = lng + Math.atan2(Math.sin(bearing) * Math.sin(radius / R) * Math.cos(lat), Math.cos(radius / R) - Math.sin(lat) * Math.sin(lat2));
      points.push([lat2 * 180 / Math.PI, lng2 * 180 / Math.PI]);
    }
    points.push(points[0]);
    return points;
  }

  map.on('click', function(e) {
    const latlng = e.latlng;

    const noFlyForm = document.getElementById('no-fly-zone-form');
    if (noFlyForm && noFlyForm.classList.contains('active')) {
      noFlyPoints.push([latlng.lat, latlng.lng]);

      const pointDiv = document.createElement('div');
      pointDiv.className = 'no-fly-point';
      pointDiv.innerHTML = `–¢–æ—á–∫–∞: [${latlng.lat.toFixed(4)}, ${latlng.lng.toFixed(4)}]`;
      document.getElementById('no-fly-points').appendChild(pointDiv);

      const marker = L.marker([latlng.lat, latlng.lng], {
        icon: L.divIcon({ className: 'no-fly-marker', html: '<div style="background: #ff4d4d; width: 12px; height: 12px; border-radius: 50%;"></div>' })
      }).addTo(map);
      noFlyMarkers.push(marker);

      if (noFlyZone) map.removeLayer(noFlyZone);
      if (noFlyPoints.length >= 3) {
        noFlyZone = L.polygon(noFlyPoints, {
          color: '#ff4d4d',
          fillColor: '#ff4d4d',
          fillOpacity: 0.2
        }).addTo(map);
      }
    } else {
      const flightForm = document.getElementById('flight-request-form');
      if (flightForm && flightForm.classList.contains('active')) {
        const routeType = document.querySelector('input[name="route-type"]:checked').value;

        if (routeType === 'points') {
          routePoints.push([latlng.lat, latlng.lng]);

          const pointDiv = document.createElement('div');
          pointDiv.className = 'route-point';
          pointDiv.innerHTML = `–¢–æ—á–∫–∞: [${latlng.lat.toFixed(4)}, ${latlng.lng.toFixed(4)}]`;
          document.getElementById('route-points').appendChild(pointDiv);

          const marker = L.marker([latlng.lat, latlng.lng], {
            icon: L.divIcon({ className: 'route-marker', html: '<div style="background: #00d4cc; width: 12px; height: 12px; border-radius: 50%;"></div>' })
          }).addTo(map);
          routeMarkers.push(marker);

          if (routePath) map.removeLayer(routePath);
          routePath = L.polyline(routePoints, { color: '#00d4cc', weight: 3 }).addTo(map);
        } else if (routeType === 'circle') {
          if (circleCenter) return;

          circleCenter = latlng;
          const pointDiv = document.createElement('div');
          pointDiv.className = 'route-point';
          pointDiv.innerHTML = `–¶–µ–Ω—Ç—Ä: [${latlng.lat.toFixed(4)}, ${latlng.lng.toFixed(4)}]`;
          document.getElementById('route-circle').appendChild(pointDiv);

          const marker = L.marker([latlng.lat, latlng.lng], {
            icon: L.divIcon({ className: 'route-marker', html: '<div style="background: #00d4cc; width: 12px; height: 12px; border-radius: 50%;"></div>' })
          }).addTo(map);
          routeMarkers.push(marker);

          const radiusInput = document.getElementById('circle-radius');
          radiusInput.oninput = () => {
            const radius = parseFloat(radiusInput.value);
            if (radius && radius >= 10) {
              if (circleOverlay) map.removeLayer(circleOverlay);
              routePoints.length = 0;
              routePoints.push(...generateCirclePoints(circleCenter, radius));
              circleOverlay = L.polyline(routePoints, { color: '#00d4cc', weight: 3 }).addTo(map);
            }
          };
        }
      }
    }
  });

  function showForm(formId) {
    const form = document.getElementById(formId);
    if (!form) return;

    if (formId === 'no-fly-zone-form' && userRole !== 'admin') {
      alert('–≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º!');
      return;
    }

    const isActive = form.classList.contains('active');
    const forms = document.querySelectorAll('.sidebar form');
    forms.forEach(f => {
      f.classList.remove('active');
    });

    if (!isActive) {
      form.classList.add('active');
    }

    if (formId === 'drone-list') updateDroneList();
    if (formId === 'pilot-list') updatePilotList();
    if (formId === 'no-fly-list') updateNoFlyList();
    if (formId === 'flight-session-list') updateFlightSessionList();
    if (formId === 'flight-request-form') updateDropdowns();

    routePoints.length = 0;
    routeMarkers.forEach(marker => map.removeLayer(marker));
    routeMarkers = [];
    if (routePath) map.removeLayer(routePath);
    if (circleOverlay) {
      map.removeLayer(circleOverlay);
      circleOverlay = null;
    }
    circleCenter = null;
    if (currentRoutePath) {
      map.removeLayer(currentRoutePath);
      currentRoutePath = null;
    }

    const routePointsDiv = document.getElementById('route-points');
    if (routePointsDiv) routePointsDiv.innerHTML = '<p>–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ—á–µ–∫ –º–∞—Ä—à—Ä—É—Ç–∞.</p>';
    const routeCircleDiv = document.getElementById('route-circle');
    if (routeCircleDiv) routeCircleDiv.innerHTML = '<p>–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ü–µ–Ω—Ç—Ä–∞ –∫—Ä—É–≥–∞.</p><label>–†–∞–¥–∏—É—Å (–º): <input type="number" id="circle-radius" placeholder="–†–∞–¥–∏—É—Å –≤ –º–µ—Ç—Ä–∞—Ö" min="10"></label>';
  }

  function registerDrone() {
    const brand = document.getElementById('drone-brand').value;
    const model = document.getElementById('drone-model').value;
    const serial = document.getElementById('drone-serial').value;
    if (brand && model && serial) {
      const drone = { brand, model, serial };
      drones.push(drone);
      localStorage.setItem('drones', JSON.stringify(drones));
      alert(`–î—Ä–æ–Ω –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω: ${brand} ${model}, —Å–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä: ${serial}`);
      document.getElementById('drone-brand').value = '';
      document.getElementById('drone-model').value = '';
      document.getElementById('drone-serial').value = '';
      updateDropdowns();
      updateDroneList();
    } else {
      alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!');
    }
  }

  function registerPilot() {
    const name = document.getElementById('pilot-name').value;
    const contact = document.getElementById('pilot-contact').value;
    if (name && contact) {
      const pilot = { name, contact };
      pilots.push(pilot);
      localStorage.setItem('pilots', JSON.stringify(pilots));
      alert(`–ü–∏–ª–æ—Ç –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω: ${name}, –∫–æ–Ω—Ç–∞–∫—Ç: ${contact}`);
      document.getElementById('pilot-name').value = '';
      document.getElementById('pilot-contact').value = '';
      updateDropdowns();
      updatePilotList();
    } else {
      alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!');
    }
  }

  function submitFlightRequest() {
    const start = document.getElementById('flight-start').value;
    const end = document.getElementById('flight-end').value;
    const maxAltitude = document.getElementById('flight-max-altitude').value;
    const droneWeight = document.getElementById('drone-weight').value;
    const droneSerial = document.getElementById('drone-model-select').value;
    const pilotContact = document.getElementById('pilot-select').value;
    const directVisibility = document.getElementById('direct-visibility').checked ? 1 : 0;
    const routeType = document.querySelector('input[name="route-type"]:checked').value;

    if (routePoints.length < 2) {
      alert('–î–æ–±–∞–≤—å—Ç–µ –º–∞—Ä—à—Ä—É—Ç (–¥–ª—è —Ç–æ—á–µ–∫ ‚Äî –º–∏–Ω–∏–º—É–º –¥–≤–µ, –¥–ª—è –∫—Ä—É–≥–∞ ‚Äî —Ü–µ–Ω—Ç—Ä –∏ —Ä–∞–¥–∏—É—Å)!');
      return;
    }

    if (!droneSerial || !pilotContact) {
      alert('–í—ã–±–µ—Ä–∏—Ç–µ –¥—Ä–æ–Ω –∏ –ø–∏–ª–æ—Ç–∞!');
      return;
    }

    let inNoFlyZone = false;

    if (noFlyZone) {
      routePoints.forEach(point => {
        if (isPointInPolygon(point, noFlyPoints)) {
          inNoFlyZone = true;
        }
      });
    }

    noFlyZones.forEach(zone => {
      routePoints.forEach(point => {
        if (isPointInPolygon(point, zone.points)) {
          inNoFlyZone = true;
        }
      });
    });

    const flightSessionId = Date.now().toString();
    const status = inNoFlyZone ? '–æ—Ç–∫–ª–æ–Ω–µ–Ω–æ (–º–∞—Ä—à—Ä—É—Ç –ø–µ—Ä–µ—Å–µ–∫–∞–µ—Ç –∑–∞–ø—Ä–µ—Ç–Ω—É—é –∑–æ–Ω—É)' : '–æ–¥–æ–±—Ä–µ–Ω–æ';
    const session = {
      flightSessionId,
      drone: drones.find(d => d.serial === droneSerial),
      pilot: pilots.find(p => p.contact === pilotContact),
      start,
      end,
      maxAltitude,
      droneWeight,
      directVisibility,
      routePoints: [...routePoints],
      routeType,
      status,
      timestamp: new Date().toISOString()
    };

    flightSessions.push(session);
    localStorage.setItem('flightSessions', JSON.stringify(flightSessions));
    document.getElementById('request-status').textContent = `–°—Ç–∞—Ç—É—Å: ${status} (–°–µ—Å—Å–∏—è #${flightSessionId})`;
    routePoints.length = 0;
    routeMarkers.forEach(marker => map.removeLayer(marker));
    routeMarkers = [];
    if (routePath) map.removeLayer(routePath);
    if (circleOverlay) {
      map.removeLayer(circleOverlay);
      circleOverlay = null;
    }
    circleCenter = null;
    const routePointsDiv = document.getElementById('route-points');
    if (routePointsDiv) routePointsDiv.innerHTML = '<p>–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ—á–µ–∫ –º–∞—Ä—à—Ä—É—Ç–∞.</p>';
    const routeCircleDiv = document.getElementById('route-circle');
    if (routeCircleDiv) routeCircleDiv.innerHTML = '<p>–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ü–µ–Ω—Ç—Ä–∞ –∫—Ä—É–≥–∞.</p><label>–†–∞–¥–∏—É—Å (–º): <input type="number" id="circle-radius" placeholder="–†–∞–¥–∏—É—Å –≤ –º–µ—Ç—Ä–∞—Ö" min="10"></label>';
    updateFlightSessionList();
  }

  function briefing() {
    const flightSessionId = document.getElementById('drone-model-select').value;
    const session = flightSessions.find(s => s.flightSessionId === flightSessionId);
    if (session) {
      alert(`–ë—Ä–∏—Ñ–∏–Ω–≥ –¥–ª—è —Å–µ—Å—Å–∏–∏ #${session.flightSessionId}: –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ –ø–æ–ª—ë—Ç–æ–º. –î—Ä–æ–Ω: ${session.drone.brand} ${session.drone.model}, –ü–∏–ª–æ—Ç: ${session.pilot.name}, –°—Ç–∞—Ç—É—Å: ${session.status}`);
    } else {
      alert('–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –∑–∞—è–≤–∫—É –Ω–∞ –ø–æ–ª—ë—Ç!');
    }
  }

  function saveNoFlyZone() {
    if (noFlyPoints.length >= 3) {
      const zone = { points: [...noFlyPoints], id: Date.now() };
      noFlyZones.push(zone);
      localStorage.setItem('noFlyZones', JSON.stringify(noFlyZones));
      renderSavedNoFlyZones();
      updateNoFlyList();
      alert('–ó–∞–ø—Ä–µ—Ç–Ω–∞—è –∑–æ–Ω–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!');
      clearNoFlyZone();
    } else {
      alert('–î–æ–±–∞–≤—å—Ç–µ –º–∏–Ω–∏–º—É–º 3 —Ç–æ—á–∫–∏ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–æ–Ω—ã!');
    }
  }

  function clearNoFlyZone() {
    noFlyPoints.length = 0;
    noFlyMarkers.forEach(marker => map.removeLayer(marker));
    noFlyMarkers = [];
    if (noFlyZone) {
      map.removeLayer(noFlyZone);
      noFlyZone = null;
    }
    const noFlyPointsDiv = document.getElementById('no-fly-points');
    if (noFlyPointsDiv) noFlyPointsDiv.innerHTML = '<p>–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ—á–µ–∫ –∑–∞–ø—Ä–µ—Ç–Ω–æ–π –∑–æ–Ω—ã.</p>';
  }

  function changeMapLayer(layer) {
    if (currentLayer === layer) return;

    const layerButtons = document.querySelectorAll('.layer-btn');
    if (layerButtons) {
      layerButtons.forEach(btn => btn.classList.remove('active'));
    }

    const activeButton = document.getElementById(`${layer}-btn`);
    if (activeButton) activeButton.classList.add('active');

    map.eachLayer(function (layer) {
      if (layer instanceof L.TileLayer) {
        map.removeLayer(layer);
      }
    });

    if (layer === 'openstreetmap') osmLayer.addTo(map);
    else if (layer === 'opentopomap') topoLayer.addTo(map);
    else if (layer === 'stamen-terrain') terrainLayer.addTo(map);

    renderSavedNoFlyZones();
    if (noFlyZone) noFlyZone.addTo(map);
    noFlyMarkers.forEach(marker => marker.addTo(map));
    if (routePath) routePath.addTo(map);
    if (circleOverlay) circleOverlay.addTo(map);
    routeMarkers.forEach(marker => marker.addTo(map));
    if (droneMarker) droneMarker.addTo(map);
    if (currentRoutePath) currentRoutePath.addTo(map);

    currentLayer = layer;
  }

  function isPointInPolygon(point, polygon) {
    let inside = false;
    for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
      const xi = polygon[i][0], yi = polygon[i][1];
      const xj = polygon[j][0], yj = polygon[j][1];
      const x = point[0], y = point[1];

      const intersect = ((yi > y) !== (yj > y)) && (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
      if (intersect) inside = !inside;
    }
    return inside;
  }

  function startMonitoring() {
    if (routePoints.length < 2) {
      alert('–°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∞–π—Ç–µ –∑–∞—è–≤–∫—É –Ω–∞ –ø–æ–ª—ë—Ç —Å –º–∏–Ω–∏–º—É–º –¥–≤—É–º—è —Ç–æ—á–∫–∞–º–∏!');
      return;
    }

    const session = flightSessions.find(s => s.routePoints.length === routePoints.length && s.routePoints.every((p, i) => p[0] === routePoints[i][0] && p[1] === routePoints[i][1]));
    if (!session || session.status.includes('–æ—Ç–∫–ª–æ–Ω–µ–Ω–æ')) {
      alert('–ó–∞—è–≤–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞ –∏–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –ø–æ–ª—ë—Ç –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω!');
      return;
    }

    if (isMonitoring) return;
    isMonitoring = true;

    if (droneMarker) map.removeLayer(droneMarker);
    let currentIndex = 0;
    droneMarker = L.marker(routePoints[0]).addTo(map)
            .bindPopup(`–î—Ä–æ–Ω: –í –ø–æ–ª—ë—Ç–µ (–°–µ—Å—Å–∏—è #${session.flightSessionId})`);

    const moveDrone = () => {
      if (!isMonitoring || currentIndex >= routePoints.length - 1) {
        isMonitoring = false;
        return;
      }

      currentIndex++;
      droneMarker.setLatLng(routePoints[currentIndex]);

      let inNoFlyZone = false;
      if (noFlyZone) {
        if (isPointInPolygon(routePoints[currentIndex], noFlyPoints)) {
          inNoFlyZone = true;
        }
      }
      noFlyZones.forEach(zone => {
        if (isPointInPolygon(routePoints[currentIndex], zone.points)) {
          inNoFlyZone = true;
        }
      });

      if (inNoFlyZone) {
        document.getElementById('alerts').textContent = '–û–ø–æ–≤–µ—â–µ–Ω–∏—è: –í—Ö–æ–¥ –≤ –∑–∞–ø—Ä–µ—Ç–Ω—É—é –∑–æ–Ω—É!';
      } else {
        document.getElementById('alerts').textContent = '–û–ø–æ–≤–µ—â–µ–Ω–∏—è: –ù–µ—Ç';
      }

      setTimeout(moveDrone, 2000);
    };

    moveDrone();
  }

  function deleteDrone(serial) {
    if (confirm(`–£–¥–∞–ª–∏—Ç—å –¥—Ä–æ–Ω —Å —Å–µ—Ä–∏–π–Ω—ã–º –Ω–æ–º–µ—Ä–æ–º ${serial}?`)) {
      drones = drones.filter(d => d.serial !== serial);
      localStorage.setItem('drones', JSON.stringify(drones));
      updateDroneList();
      updateDropdowns();
      alert(`–î—Ä–æ–Ω —Å —Å–µ—Ä–∏–π–Ω—ã–º –Ω–æ–º–µ—Ä–æ–º ${serial} —É–¥–∞–ª—ë–Ω`);
    }
  }

  function deletePilot(contact) {
    if (confirm(`–£–¥–∞–ª–∏—Ç—å –ø–∏–ª–æ—Ç–∞ —Å –∫–æ–Ω—Ç–∞–∫—Ç–æ–º ${contact}?`)) {
      pilots = pilots.filter(p => p.contact !== contact);
      localStorage.setItem('pilots', JSON.stringify(pilots));
      updatePilotList();
      updateDropdowns();
      alert(`–ü–∏–ª–æ—Ç —Å –∫–æ–Ω—Ç–∞–∫—Ç–æ–º ${contact} —É–¥–∞–ª—ë–Ω`);
    }
  }

  function deleteNoFlyZone(id) {
    if (confirm(`–£–¥–∞–ª–∏—Ç—å –∑–∞–ø—Ä–µ—Ç–Ω—É—é –∑–æ–Ω—É #${id}?`)) {
      noFlyZones = noFlyZones.filter(z => z.id !== id);
      savedNoFlyPolygons = savedNoFlyPolygons.filter(p => p.options.id !== id);
      localStorage.setItem('noFlyZones', JSON.stringify(noFlyZones));
      renderSavedNoFlyZones();
      updateNoFlyList();
      alert(`–ó–∞–ø—Ä–µ—Ç–Ω–∞—è –∑–æ–Ω–∞ #${id} —É–¥–∞–ª–µ–Ω–∞`);
    }
  }

  function deleteFlightSession(id) {
    if (confirm(`–£–¥–∞–ª–∏—Ç—å —Å–µ—Å—Å–∏—é #${id}?`)) {
      flightSessions = flightSessions.filter(s => s.flightSessionId !== id);
      localStorage.setItem('flightSessions', JSON.stringify(flightSessions));
      if (currentRoutePath) {
        map.removeLayer(currentRoutePath);
        currentRoutePath = null;
      }
      updateFlightSessionList();
      alert(`–°–µ—Å—Å–∏—è #${id} —É–¥–∞–ª–µ–Ω–∞`);
    }
  }

  async function fetchWeather(lat, lon) {
    const now = Date.now();
    if (now - lastWeatherUpdate < 5000) return;
    lastWeatherUpdate = now;

    try {
      const apiKey = '00150018ecbe7940cdd3818ae9c549f4';
      const response = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${apiKey}&units=metric`);
      if (!response.ok) {
        throw new Error(`–û—à–∏–±–∫–∞ HTTP: ${response.status} (${response.statusText})`);
      }
      const data = await response.json();
      const temp = data.main.temp;
      const wind = data.wind.speed;
      document.getElementById('weather-bar').innerHTML = `–ü–æ–≥–æ–¥–∞ –≤ –ê—Å—Ç–∞–Ω–µ: +${temp.toFixed(0)}¬∞C, –í–µ—Ç–µ—Ä: ${wind.toFixed(1)} –º/—Å`;
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø–æ–≥–æ–¥—ã:', error.message);
      document.getElementById('weather-bar').innerHTML = `–ü–æ–≥–æ–¥–∞ –≤ –ê—Å—Ç–∞–Ω–µ: +15¬∞C, –í–µ—Ç–µ—Ä: 5 –º/—Å (–æ—à–∏–±–∫–∞: –ø—Ä–æ–≤–µ—Ä—å—Ç–µ API-–∫–ª—é—á –Ω–∞ https://openweathermap.org/)`;
    }
  }

  function updateWeatherForAstana() {
    fetchWeather(51.1694, 71.4491);
  }

  map.on('load', updateWeatherForAstana);
  updateWeatherForAstana();
  renderSavedNoFlyZones();
  updateDropdowns();
  updateDroneList();
  updatePilotList();
  updateNoFlyList();
  updateFlightSessionList();

  function toDMS(coord, isLat) {
    const deg = Math.floor(coord);
    const min = Math.floor((coord - deg) * 60);
    const sec = ((coord - deg - min / 60) * 3600).toFixed(0);
    return `${deg}¬∞${min}'${sec}"${isLat ? (coord >= 0 ? 'N' : 'S') : (coord >= 0 ? 'E' : 'W')}`;
  }

  map.on('move', () => {
    const center = map.getCenter();
    const lat = toDMS(center.lat, true);
    const lng = toDMS(center.lng, false);
    document.getElementById('coords-bar').innerHTML = `–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${lat} ${lng}`;
  });
</script>
</body>
</html>